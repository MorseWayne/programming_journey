---
title: å‡½æ•°ä½¿ç”¨æŠ€å·§
icon: /assets/icons/article.svg
order: 3
category:
  - Go
---

æœ¬ç« è°ˆä¸€è°ˆé˜…è¯»äº†[GOè¯­è¨€åœ£ç»](https://golang-china.github.io/gopl-zh/ch5/ch5.html)ä¹‹åï¼Œå…³äºGOå‡½æ•°ä½¿ç”¨åŒºåˆ«äºå…¶ä»–è¯­è¨€çš„ä¸€äº›ä½“ä¼šã€‚

## 1 åŸºæœ¬èŒƒå¼

goé‡Œé¢å‡½æ•°çš„åŸºæœ¬å£°æ˜èŒƒå¼å¦‚ä¸‹ï¼š

```go
func name(parmeter-list) (result-list) {
    body
}
```

è¿™ä¸€ç‚¹å‘½åé£æ ¼ï¼Œæœ‰ç‚¹å’Œ`Rust`å’Œ`Javascript`æ¥è¿‘ï¼Œå‡½æ•°çš„è¿”å›å€¼æ˜¯ç´§è·Ÿå†å‚æ•°åˆ—è¡¨åçš„ã€‚`parmeter-list` å’Œ `result-list` éƒ½å¯ä»¥çœç•¥ï¼Œå‰è€…çœç•¥ä»£è¡¨ä¸éœ€è¦å‡½æ•°å‚æ•°ï¼Œåè€…çœç•¥ä»£è¡¨æ²¡æœ‰è¿”å›å€¼ã€‚

## 2 å½¢å‚å£°æ˜çš„æŠ€å·§

### 2.1 å‚æ•°åˆå¹¶

å¯¹äºå‚æ•°åˆ—è¡¨ï¼Œç›¸é‚»çš„åŒç±»å‹å‚æ•°å¯ä»¥è¿›è¡Œåˆå¹¶å£°æ˜

```go
func f(i, j, k int, s, t string)                 { /* ... */ }
func f(i int, j int, k int,  s string, t string) { /* ... */ }
```

### 2.2 å‚æ•°å¿½ç•¥

ç”±äºGOå¯¹ä¸ä½¿ç”¨çš„å˜é‡çš„æ£€æŸ¥éå¸¸ä¸¥æ ¼ï¼ŒæŸäº›åœºæ™¯ä¸‹ä½ å¯ä»¥å®šä¹‰ä¸€äº›å½¢å‚ï¼Œä½†æ˜¯æ°¸è¿œéƒ½ä¸ä¼šä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç©ºç™½æ ‡è¯†ç¬¦(blank identifier)`_`æ¥è¿›è¡Œå ä½
ä¾‹å¦‚ï¼š

```go
// éƒ¨åˆ†å‚æ•°çœç•¥
func test(x int, _ int) { /* ... */ }

// çœç•¥æ‰€æœ‰å‚æ•°
func test(int, int) { /* ... */ }
```

## 3 å‡½æ•°çš„å¤šè¿”å›å€¼

ä»å£°æ˜èŒƒå¼ä¸éš¾çœ‹å‡ºï¼Œè¿”å›å€¼å¯ä»¥æ˜¯ä¸€ç³»åˆ—çš„å€¼ï¼Œä½†æ˜¯å£°æ˜è¿”å›å€¼éœ€è¦ç”¨æ‹¬å·å¯¹è¿”å›çš„ç±»å‹åˆ—è¡¨è¿›è¡ŒåŒ…è£¹ï¼Œæ¯”å¦‚ï¼š

```go
func test(a, b int) (int, int) {
 return a, b
}

// å‡½æ•°è°ƒç”¨ç¤ºä¾‹
val1, val2 := test(0, 0)
```

## 4 é”™è¯¯å¤„ç†

### 4.1 æ§åˆ¶æµé£æ ¼

ä¸ªäººè§‰å¾—è¿™ä¸€ç‚¹è¿˜æ˜¯â€œåç”Ÿâ€ `Rust` æ›´åŠ ä¼˜é›…ï¼ŒGOé‡Œé¢è¿˜æ˜¯å…¸å‹çš„æ§åˆ¶æµå¼‚å¸¸å¤„ç†é£æ ¼ï¼Œç±»`C`æˆ–è€…`C++`(å¬è¯´æ˜¯ä½œè€…ä¸ºäº†æ–¹ä¾¿å®šä½é—®é¢˜æ•…æ„è¿™ä¹ˆè®¾è®¡çš„ğŸ˜‚)ï¼Œ
ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š

```go
func test() (int,int) {
    resp, err := myfunc()
    if err != nil {
        return nil, err
    }
    // continue do something
}
```

æˆ‘ä»¬å¯ä»¥å¯¹æ¯”çœ‹ä¸‹`Rust`é‡Œé¢çš„é£æ ¼æ˜¯æ›´åŠ ä¼˜ç§€çš„ï¼Œä¸€æ—¦å¼‚å¸¸åˆ†æ”¯å¤šäº†ï¼Œä¸‹é¢è¿™ç§å†™æ³•çš„ä¼˜åŠ¿å°±æ›´åŠ æ˜æ˜¾äº†ï¼š

```rust
fn test() -> Result<(), Box<dyn Error>> {
    let resp = myfunc()?;
    // continue do something
    Ok(())
}
```

### 4.2 panicä½¿ç”¨

`panic`æ˜¯GOç¼–ç¨‹é‡Œé¢ï¼Œç”¨äºè¡¨ç¤ºç¨‹åºå‘ç”Ÿé‡å¤§é”™è¯¯çš„ä¸€ä¸ªæ–¹å¼ï¼Œæ‰§è¡Œå®Œpanicæ“ä½œåï¼Œå½“panicå¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œç¨‹åºä¼šä¸­æ–­è¿è¡Œï¼Œå¹¶ç«‹å³æ‰§è¡Œåœ¨è¯¥goroutineä¸­è¢«å»¶è¿Ÿçš„å‡½æ•°ï¼ˆ[defer æœºåˆ¶](/docs/language/go/basic/function.md#_8-å»¶è¿Ÿè°ƒç”¨-defer-function-call)ï¼‰ã€‚ç”±äºpanicåœ¨æ²¡æœ‰è¢«æ˜¾ç¤ºå¤„ç†çš„æƒ…å†µä¸‹ä¼šå¯¼è‡´è¿›ç¨‹é€€å‡ºï¼Œæ‰€ä»¥æ…ç”¨ï¼

ç®€å•ç¤ºä¾‹ï¼š

```go
package main

import "fmt"

func startTrace() func() {
 println("enter")
 return func() {
  println("exit")
 }
}

func test(ptr *int) {
 if ptr == nil {
  panic("pis is null")
 }
 fmt.Println("hello world")
}

func main() {
 test(nil)
}
```

è¿è¡Œè¯¥ä»£ç ï¼Œè·å¾—è¾“å‡ºå¦‚ä¸‹ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¼‚å¸¸æ‰“å°ä¿¡æ¯å’Œæ ˆä¿¡æ¯ï¼Œä»¥åŠå‘ç”Ÿå¼‚å¸¸çš„ä»£ç è¡Œï¼š

```go
wayne@server:~/source/practice/go/temp$ go run main.go 
panic: pis is null

goroutine 1 [running]:
main.test(0xc000002380?)
        /home/wayne/source/practice/go/temp/main.go:14 +0x65
main.main()
        /home/wayne/source/practice/go/temp/main.go:20 +0x15
exit status 2
```

### 4.3 å¼‚å¸¸æ•è·

`GO`è¯­è¨€æä¾›äº†`recover`å‡½æ•°ä¸ºå¼€å‘è€…é¢„ç•™äº†å¤„ç†`panic`è¿™ç§`fatal error`çš„ä¸¥é‡é”™è¯¯çš„æ–¹å¼ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ˜¯ä¸å»ºè®®å¤„ç†`panic`çš„ï¼Œå› ä¸ºè¿™ä¼šå¼•å‘å¾ˆå¤šçš„èµ„æºä½¿ç”¨çš„é—®é¢˜ï¼Œæ‰€ä»¥è¦é€‰æ‹©æ€§çš„ä½¿ç”¨recoverï¼Œè€Œä¸æ˜¯ç›²ç›®çš„ä½¿ç”¨ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•æ•è·panicçš„ç¤ºä¾‹ï¼š

```go
package main

func test(ptr *int) {
	if ptr == nil {
		panic("pis is null")
	}
}

func getDeferFunc() func() {
	return func() {
		switch err := recover(); err {
		case nil:
			println("no err.")
		case "pis is null":
			println("fatal err!")
		default:
			panic(err)
		}
	}
}

func case1Test() {
	defer getDeferFunc()()
	print("case1: ")
	test(nil)
}

func case2Test() {
	defer getDeferFunc()()
	print("case2: ")
	test(new(int))
}

func main() {
	case1Test()
	case2Test()
}

```

## 5 å‡½æ•°å€¼(Funciton values)

ç¬¬ä¸€æ¬¡å¯èƒ½å¬èµ·æ¥æ¯”è¾ƒé™Œç”Ÿï¼Œç®€å•æ¥è¯´ï¼Œè¿™ä¸ª`GO`é‡Œé¢çš„åƒ`C++`è¯­è¨€çš„å‡½æ•°æŒ‡é’ˆè¯­ä¹‰ï¼Œæœ‰ç‚¹ç±»ä¼¼äºC++é‡Œé¢çš„å‡½æ•°å¯¹è±¡ `std::function`,
æœ¬è´¨ä¸Šå°±æ˜¯å¯¹äºGOé‡Œé¢å®šä¹‰çš„å‡½æ•°å¯ä»¥æŠŠå®ƒå½“ä½œä¸€ä¸ªå€¼èµ‹å€¼ç»™å…¶ä»–å˜é‡ï¼Œä¸”è¿™ä¸ªå˜é‡æ˜¯å¯è°ƒç”¨(`callable`)çš„ã€‚è¯ä¸å¤šè¯´ï¼Œshow you the code:

```go
package main

import "fmt"

func printSth(val int) {
	fmt.Println("val: ", val)
}

func main() {
	var f = printSth
	f(10)
}
// output
val: 10
```

ä¸å¾—ä¸è¯´ï¼Œè¿™ä¸€ç‚¹è¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚

## 6 åŒ¿åå‡½æ•°(Anonymous Functions)

åŒ¿åå‡½æ•°å…¶å®å°±æ˜¯å…¶ä»–ç¼–ç¨‹è¯­è¨€è®²çš„å‡½æ•°é—­åŒ…(`closures`)ï¼Œ ç±»ä¼¼äº`C++`çš„`lamda`è¡¨è¾¾å¼ï¼Œé—­åŒ…åŒ…å«äº†ä¸€ä¸ªå‡½æ•°çš„è¡Œä¸ºä»¥åŠå‡½æ•°ä¾èµ–çš„æ•°æ®ï¼Œç”±äºè¿™ä¸ªå‡½æ•°åœ¨å®šä¹‰çš„æ—¶å€™æ²¡æœ‰å‡½æ•°åï¼Œæ‰€ä»¥å«**åŒ¿åå‡½æ•°**ï¼Œ

```go
var f = func(val int) { fmt.Println("val: ", val) }
f(10) // output: val: 10
```

ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„ç‚¹æ˜¯ï¼Œå¯¹äºé—­åŒ…å¤–éƒ¨å˜é‡çš„æ•è·ï¼Œæ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œè¿™æ˜¯å› ä¸º`GO`çš„`GC`æœºåˆ¶ï¼Œç”±äºé—­åŒ…å¯¹å¤–éƒ¨å˜é‡è¿›è¡Œäº†æ•è·ï¼Œå¯¼è‡´å…¶ç”Ÿå‘½å‘¨æœŸå»¶é•¿(è¿™ä¸ªè¡Œä¸ºä¹Ÿå«å˜é‡çš„é€ƒé€¸)ï¼Œæ‰€ä»¥ä¸€å®šè¦æ³¨æ„é—­åŒ…çš„é‡å…¥æ€§è®¾è®¡ï¼Œå…¸å‹ç¤ºä¾‹å¦‚ä¸‹ï¼š

```go
package main

import "fmt"

func main() {
	var x int
	var f = func() int {
		x++
		return x * x
	}

	fmt.Println(f()) // æ‰“å° "1"
	fmt.Println(f()) // æ‰“å° "4"
	fmt.Println(f()) // æ‰“å° "9"
	fmt.Println(f()) // æ‰“å° "16"
}
```

ä¹Ÿè®¸ä¸Šé¢çš„çœ‹èµ·æ¥è¿˜ä¸æ˜¯å¾ˆå¥‡æ€ªï¼Œä¸è¿‡å†æ¢ä¸€ç§å½¢å¼ï¼Œå¯èƒ½å°±ä¼šç»™`C++`å¼€å‘è€…ä¸€äº›å°å°çš„éœ‡æ’¼äº†ï¼š

```go
package main

import "fmt"

func getFunc() func() int {
	var x int
	return func() int {
		x++
		return x * x
	}
}

func main() {

	var f = getFunc()
	fmt.Println(f()) // æ‰“å° "1"
	fmt.Println(f()) // æ‰“å° "4"
	fmt.Println(f()) // æ‰“å° "9"
	fmt.Println(f()) // æ‰“å° "16"
}
```

ä¸Šé¢è¿™ä¸ªç¤ºä¾‹ï¼Œ`x`æ˜¯æ”¾åœ¨äº†ä¸€ä¸ªå±€éƒ¨å‡½æ•°é‡Œé¢ï¼Œç”±äºå°†å…¶ä½œä¸ºé—­åŒ…çš„æ•°æ®è¿”å›äº†å‡ºå»ï¼Œå¯¼è‡´`x`é€ƒé€¸ï¼Œä¹Ÿæ˜¯è¯´ï¼Œ`x`å®é™…æ˜¯åˆ†é…åœ¨å †ä¸Šçš„ã€‚

## 7 å¯å˜å‚æ•°

`GO`çš„å¯å˜å‚æ•°ä¸`C++`çš„å‚æ•°åŒ…çš„æ¦‚å¿µç±»ä¼¼ï¼Œéƒ½æ˜¯ä¸ºäº†æä¾›ä¸€ä¸ªçµæ´»æ¥æ”¶ä»»æ„åŒç±»å‹å‚æ•°çš„å£°æ˜æ–¹å¼ã€‚
ä½¿ç”¨æ–¹æ³•ï¼Œåœ¨æœ€åä¸€ä¸ªå‚æ•°ç±»å‹ä¹‹å‰åŠ ä¸Š`...`,

**ç¤ºä¾‹1ï¼Œç®€å•ä½¿ç”¨ï¼š**

```go
func sum(vals ...int) int {
	ans := 0
	for _, val := range vals {
		ans += val
	}
	return ans
}

func main() {
	fmt.Println(sum(1))
	fmt.Println(sum(1, 2))
	fmt.Println(sum(1, 2, 3))
}
```

**ç¤ºä¾‹2ï¼Œå¯å˜å‚æ•°å±•å¼€**

ä¸‹é¢è¿™ä¸ªä»£ç é€’å½’å±•å¼€ä¸€ä¸ªå¯å˜å‚æ•°åŒ…

```go
func recursive(val int, vals ...int) {
	println(val)
	if len(vals) > 0 {
		recursive(vals[0], vals[1:]...)
	} else {
		println("exit!")
	}
}

func main() {
	recursive(1, 2, 3, 4)
}
```

ç¨‹åºå°†ä¼šæœ‰å¦‚ä¸‹è¾“å‡ºï¼š

```bash
1
2
3
4
exit!
```

## 8 å»¶è¿Ÿè°ƒç”¨(Defer function call)

åœ¨`GO`é‡Œé¢é¦–æ¬¡å­¦åˆ°ä¹Ÿæ˜¯è€³ç›®ä¸€æ–°ï¼Œè¿™ä¸ªæ„Ÿè§‰è¿™æ˜¯`RAII`ç¼–ç¨‹åœ¨è¯­è¨€çš„è¯­æ³•å±‚é¢çš„ä¸€ç§ä¼˜ç§€å®ç°ï¼Œå…ˆçœ‹ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ç¤ºä¾‹ï¼š

```go
func main() {
    fmt.Println("A")
    defer fmt.Println("B")  // å»¶è¿Ÿåˆ° main è¿”å›å‰æ‰§è¡Œ
    fmt.Println("C")
}
```

æ‰“å°é¡ºåºï¼š`A, C, B`ã€‚

ä¸éš¾çœ‹å‡ºï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯æ‰§è¡Œ`defer`æ‰€åœ¨è¯­å¥è¡Œåé¢æŒ‡å®šçš„å‡½æ•°ï¼Œæ‰§è¡Œçš„æ—¶æœºæ˜¯åœ¨å‡½æ•°è¿”å›æ—¶æ‰§è¡Œï¼Œæ— è®ºæ˜¯`return`çš„æ–¹å¼é€€å‡ºï¼Œè¿˜æ˜¯ç¨‹åºä»¥`panic`çš„å¼‚å¸¸æ–¹å¼é€€å‡ºã€‚

### 8.1 ä½¿ç”¨é™åˆ¶

`GO`è¯­è¨€è§„èŒƒé‡Œé¢è¡¨æ˜ï¼š`defer`åé¢ç»‘å®šçš„åªèƒ½æ˜¯å‡½æ•°è°ƒç”¨çš„è¡¨è¾¾å¼ï¼Œä¸æ”¯æŒå…¶ä»–è¡¨è¾¾å¼ï¼Œæ¯”å¦‚

```go
var x int
defer x++ // compile error
```

### 8.2 deferçš„å‚æ•°æ±‚å€¼æ—¶æœº

çœ‹ä¸€ä¸ªéå¸¸å…¸å‹çš„ä¾‹å­ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹å‡½æ•°è°ƒç”¨å¼€å§‹å’Œç»“æŸçš„traceçš„ç®€æ˜“å®ç°

```go
package main

func startTrace() func() {
 println("enter")
 return func() {
  println("exit")
 }
}

func main() {
 defer startTrace()()
 println("do sth")
}
```

ä½ å°†ä¼šçœ‹åˆ°ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š

```bash
enter
do sth
exit
```

ç®€å•ç†è§£ï¼Œdeferä¼šå°†åé¢çš„è¡¨è¾¾å¼è½¬æ¢ä¸º`å‡½æ•° + (æ±‚å€¼åçš„å‚æ•°å¿«ç…§)` çš„å½¢å¼ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­

`startTrance()()`è¢«è½¬æ¢æˆäº† **è¿”å›çš„åŒ¿åå‡½æ•°** è¢«`defer`æŒ‚èµ·ï¼Œä½ å¯èƒ½è¿˜æ˜¯ä¸ç†è§£ï¼Œæˆ‘å†ä¸¾ä¸ªä¾‹å­

å¦‚æœä½ æœ‰ä¸€ä¸ªå‡½æ•°è®¾è®¡å¹¶ä¸”åšäº†å¾ˆå¤æ‚çš„deferç»‘å®šï¼š

```go
func getFunc() func() func() func() func() {
 return func() func() func() func() {
  return func() func() func() {
   return func() func() {
    return func() {
     println("hello")
    }
   }
  }
 }
}

func main() {
 defer getFunc()()()()()
 println("do sth")
}
```

 `getFunc()()()()()` å…¶å®å¯ä»¥è¢«æ‹†è§£ä¸º `getFunc()()()()` + `()`ï¼Œå½“ç„¶ï¼Œç¼–è¯‘å™¨èƒŒåçš„é€»è¾‘å¾ˆå¤æ‚ï¼Œä½ çŸ¥é“æœ€ç»ˆçš„ç»“æœæ˜¯è¿™ä¹ˆå›äº‹å„¿å°±å¥½äº†ã€‚

### 8.3 å¤šä¸ªdeferä¸‹çš„æ‰§è¡Œé¡ºåº

ç”±äºdeferçš„åº•å±‚ç¼–è¯‘å™¨å®ç°æ˜¯LIFOï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§å£°æ˜çš„é¡ºåºå…¥æ ˆï¼Œæ‰€ä»¥ï¼Œå¦‚æœåå£°æ˜çš„deferç»‘å®šä¼šåœ¨å‡½æ•°é€€å‡ºæ—¶å…ˆæ‰§è¡Œï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```go
func main() {
    defer fmt.Println("1")
    defer fmt.Println("2")
    defer fmt.Println("3")
}
// è¾“å‡ºé¡ºåºï¼š 3, 2, 1
```
